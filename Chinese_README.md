# ParaSeed-Agent 系统安装、介绍和用户指南 🌱🤖

<中文版本>  [<英文版本>](README.md)  

## 介绍 📖

ParaSeed-Agent 是一个专为农业领域设计的多功能智能代理系统。通过集成多种人工智能模型和工具，它能够智能地分析和响应用户输入。它可以处理多种类型的任务，包括：

- **一般文本问答** 📝
- **多模态处理（如图像分析）** 🖼️
- **作物生长监测** 🌾
- **数据库查询与存储** 🗄️
- **传感器参数获取、设置和控制** 📡

## 功能特性 ✨

- **多任务处理**：自动识别用户输入的任务类型，并调用相应的执行代理进行处理。
- **MQTT 传感器控制**：通过 MQTT 协议，实现对传感器的远程监控和控制。
- **多模态处理**：集成多模态模型（如 ParaSeed-Multi），能够对图像进行分析和处理，提供专业的农业领域图像分析。
- **数据库查询与存储**：支持对数据库的智能查询和处理，同时能够将传感器数据实时存储到远程数据库中。
- **作物生长监测**：通过控制摄像头位置，获取作物的实时图像，并分析其生长状态。

## 环境要求 🖥️

- **操作系统**：支持 Windows、macOS 和 Linux
- **Python 版本**：3.6 及以上
- **依赖库**：

  - `openai`
  - `torch`
  - `transformers`
  - `Pillow`（PIL）
  - `peft`
  - `opencv-python`（cv2）
  - `pandas`
  - `pymysql`
  - `paho-mqtt`
  - `langchain`
  - `langchain_experimental`

## 安装指南 🚀

### 1. 克隆或下载代码 📥

```bash
git clone https://github.com/your-repo/ParaSeed-Agent.git
```

### 2. 安装依赖库 📦

在项目目录下，运行以下命令安装所需的 Python 库：

```bash
pip install -r requirements.txt
```

*如果没有 `requirements.txt` 文件，可以手动安装所需库：*

```bash
pip install openai torch transformers Pillow peft opencv-python pandas pymysql paho-mqtt langchain langchain_experimental
```

### 3. 配置环境变量 🔧

在代码中，配置 OpenAI API 的密钥和基本 URL：

```python
import os
os.environ["OPENAI_API_KEY"] = "你的 OpenAI API 密钥"
os.environ["OPENAI_BASE_URL"] = "https://api.openai.com/v1"
```

**注意**：请确保安全地存储和使用 API 密钥，不要将其公开在代码库中。

## 使用指南 📚

### 1. 启动程序 ▶️

在命令行中运行主程序：

```bash
python main.py
```

程序将提示您输入问题：

```bash
请输入您的问题：
```

### 2. 输入问题 💬

您可以输入以下类型的问题：

- **一般性文本问题**：例如，“今天天气怎么样？” ☀️
- **多模态问题**：涉及图像分析的问题，系统将自动捕获图像或您可以提供图像路径。 🖼️
- **作物生长监测**：例如，“请帮我分析一下2号作物的生长情况。” 🌱
- **数据库查询**：例如，“请查询一下2023年8月27日的大棚温度和湿度。” 🌡️💧
- **传感器控制**：例如，“将传感器的温度设置为25摄氏度。” 🔥

### 3. 系统响应 📝

系统将根据您的输入自动识别任务类型，并调用相应的代理进行处理。处理完成后，将输出结果。

## 主要模块介绍 🧩

ParaSeed-Agent 系统由多个模块组成，每个模块都承担特定的功能。下面对主要模块进行详细介绍，特别是关于远程数据库的对接、存储和查询，以及作物生长监测的实际操作流程。

### 1. 主程序逻辑 (`main` 函数) 🧠

**功能**：负责整体流程控制，包括接收用户输入、调用问题分析代理、分配任务给相应的执行代理、汇总结果并输出。

**流程**：

1. **接收用户输入**：获取用户的问题和（可选的）图像数据。
2. **问题分析**：调用 `QuestionAnalysisAgent` 分析用户输入，确定任务类型。
3. **任务分配与执行**：根据任务类型，实例化对应的执行代理，并调用其 `execute` 方法。
4. **结果汇总**：使用 `SummaryAgent` 汇总各执行代理的结果，形成最终回答。

### 2. 问题分析代理 (`QuestionAnalysisAgent`) 🧐

**功能**：使用 GPT 模型分析用户的输入，确定任务类型。

**任务类型**：

- `gpt`：一般性文本问题
- `multimodal`：多模态处理（如图像分析）
- `crop_growth`：作物生长监测
- `database`：数据库查询
- `sensor_control`：传感器参数获取、设置和控制

**主要方法**：

- `analyze(extracted_user_input)`：接收用户输入，使用预设的提示模板调用 GPT 模型，返回任务类型。

### 3. MQTT 传感器控制代理 (`MQTTSensorControlAgent`) 📡

**功能**：通过 MQTT 协议，与传感器设备通信，实现参数获取和设置。

**主要方法**：

- `get_sensor_value()`：订阅传感器主题，获取传感器的当前值。
- `set_control_value(control_param)`：向控制主题发布消息，设置传感器参数。
- `execute(user_input)`：解析用户输入，确定是查询还是设置操作，并执行相应的方法。

### 4. 多模态处理代理 (`ParaSeedMultiAgent`) 🖼️

**功能**：调用多模态模型（如 ParaSeed-Multi），对图像和文本进行联合分析，提供专业的农业领域图像解读。

**主要方法**：

- `call_paraseed_multi(image_paths, question, history)`：与多模态模型进行交互，发送图像和问题，获取分析结果。
- `capture_image()`：通过摄像头或视频流抓取实时图像，用于分析。
- `execute(user_input)`：接收用户输入，捕获图像，调用多模态模型进行处理，并返回结果。

### 5. 作物生长执行代理 (`CropGrowthExecutionAgent`) 🌾

**功能**：根据指定的作物编号，控制摄像头移动到相应位置，获取作物图像，并进行生长状况分析。

**主要方法**：

- `update_topics(deviceID)`：根据设备 ID 动态更新 MQTT 主题。
- `get_current_position_from_sensor()`：获取传感器当前的位置。
- `set_control_value(deviceID, control_param)`：设置设备的控制参数，移动摄像头到目标位置。
- `capture_image()`：捕获当前摄像头位置的图像。
- `call_gpt4_vision(image_path, question)`：调用 GPT-4 视觉模型，对图像进行分析。
- `execute(user_input)`：综合以上方法，完成作物生长的分析任务。

**详细说明**：

- **位置判断与调整**：当用户询问某个作物的生长情况时，系统首先通过 `get_current_position_from_sensor()` 获取摄像头当前的位置。如果摄像头不在目标作物的位置，则通过 `set_control_value()` 控制滑轨移动到对应的作物位置。
- **图像捕获与分析**：摄像头到达目标位置后，调用 `capture_image()` 获取作物的实时图像。然后使用 `call_gpt4_vision()` 或 `call_paraseed_multi()` 对图像进行分析，判断作物的生长状态，并给出结论。

### 6. 数据库查询代理 (`DatabaseQueryAgent`) 🗄️

**功能**：解析用户的数据库查询请求，生成 SQL 语句，并执行查询，返回结果。

**主要方法**：

- `_parse_database_info(user_input)`：使用 GPT 模型，从用户输入中解析出数据库名、表名和 SQL 查询语句。
- `execute(user_input)`：执行数据库查询，并根据结果生成适当的回答。

**详细说明**：

- **查询结果处理**：
  - **有数据的情况**：如果数据库中有对应的数据，系统将获取查询结果，整理后返回给用户。
  - **无数据的情况**：如果数据库中没有相关数据，系统将启动传感器进行实时测量，然后将测量后的数据存储到远程数据库中，并告知用户当前的信息。

### 7. 传感器监测代理 (`SensorMonitorAgent`) 📈

**功能**：实时监听传感器数据，保存到远程数据库，并根据用户请求提供最新的传感器状态。

**主要方法**：

- `on_connect(client, userdata, flags, rc)`：MQTT 连接回调函数，订阅传感器主题。
- `on_message(client, userdata, msg)`：MQTT 消息回调函数，处理接收到的传感器数据。
- `process_sensor_data(sensor_data)`：处理传感器数据，生成 SQL 插入语句。
- `generate_sql_insert(sensor_data)`：使用 GPT 模型，生成插入数据到数据库的 SQL 语句。
- `insert_data_to_database(sensor_data)`：执行 SQL 插入操作，将数据保存到数据库中。
- `execute(user_input)`：等待传感器数据接收完成，根据用户输入和传感器数据生成回答。

**详细说明**：

- **数据存储与查询流程**：
  - 当用户查询某个时间点的大棚信息时，系统首先尝试从数据库中获取数据。
  - **如果数据存在**：直接返回查询结果，整理后提供给用户。
  - **如果数据不存在**：系统启动传感器进行实时测量，获取最新的数据。
    - 将新获取的数据存储到远程数据库中，确保数据的持续更新。
    - 将当前的测量结果返回给用户，告知最新的信息。

### 8. GPT 执行代理 (`GPTExecutionAgent`) 📝

**功能**：处理一般性的文本问题，调用 GPT 模型生成回答。

**主要方法**：

- `execute(user_input)`：直接调用 GPT 模型，生成对用户问题的回答。

### 9. 总结代理 (`SummaryAgent`) 📊

**功能**：汇总各个执行代理的结果，形成一个完整的答案。

**主要方法**：

- `summarize(results)`：接收一个结果列表，进行汇总处理。

## 注意事项 ⚠️

- **API 密钥安全** 🔐：请确保您的 API 密钥保存在安全的地方，不要直接在代码中明文显示。
- **MQTT 配置** 🌐：在使用 MQTT 功能前，请确保正确配置 MQTT 服务器的地址、端口、用户名和密码。
- **数据库配置** 💾：在使用数据库功能前，请确保数据库连接信息正确，并已创建所需的数据库和表。
- **错误处理** ❗：在实际部署中，建议为各个模块添加异常处理，确保系统的健壮性。

## 示例 📖

### 示例一：查询大棚温度和湿度 🌡️💧

**用户输入**：

```bash
请输入您的问题：请帮我从 greenhouse_data 表中查询一下2023年8月27日的温度和湿度。
```

**系统处理流程**：

1. **问题分析**：`QuestionAnalysisAgent` 识别任务类型为 `database`。
2. **执行代理**：`DatabaseQueryAgent` 解析用户输入，生成 SQL 查询语句。
3. **查询数据库**：
   - **有数据的情况**：
     - 系统在数据库中找到对应日期的数据。
     - 将查询结果整理后返回给用户。
     - **系统响应**：
       ```
       2023年8月27日的大棚温度为25摄氏度，湿度为60%。
       ```
   - **无数据的情况**：
     - 系统在数据库中未找到对应日期的数据。
     - **自动测量**：
       - 启动 `SensorMonitorAgent`，激活传感器进行实时测量。
       - 将测量结果存储到远程数据库。
     - **返回结果**：
       ```
       数据库中未找到2023年8月27日的数据。已进行实时测量，当前温度为26摄氏度，湿度为58%。
       ```

### 示例二：查询作物的生长情况 🌱

**用户输入**：

```bash
请输入您的问题：请分析一下2号作物的当前生长状况。
```

**系统处理流程**：

1. **问题分析**：`QuestionAnalysisAgent` 识别任务类型为 `crop_growth`。
2. **执行代理**：`CropGrowthExecutionAgent` 负责处理该任务。
3. **位置判断与调整**：
   - 系统通过 `get_current_position_from_sensor()` 获取摄像头的当前位置信息。
   - 判断摄像头是否在 2 号作物的位置。
     - **如果在目标位置**：
       - 直接进行图像捕获和分析。
     - **如果不在目标位置**：
       - 通过 `set_control_value()` 控制滑轨移动摄像头到 2 号作物的位置。
       - 等待移动完成后，进行图像捕获。
4. **图像捕获与分析**：
   - 使用 `capture_image()` 获取 2 号作物的实时图像。
   - 调用 `ParaSeedMultiAgent`，使用 ParaSeed-Multi 多模态大模型对作物生长状态进行分析。
5. **返回结果**：
   - 将分析结果整理后，提供给用户。
   - **系统响应**：
     ```
     2号作物目前生长良好，叶片颜色正常，无明显病虫害迹象。
     ```

### 示例三：传感器参数控制 🔧

**用户输入**：

```bash
请输入您的问题：将传感器的温度设置为22摄氏度。
```

**系统处理流程**：

1. **问题分析**：`QuestionAnalysisAgent` 识别任务类型为 `sensor_control`。
2. **执行代理**：`MQTTSensorControlAgent` 解析用户输入，提取需要设置的参数。
3. **执行控制**：
   - 通过 MQTT 协议，向控制主题发布设置温度的指令。
   - 等待控制反馈，确认指令执行成功。
4. **返回结果**：
   - **系统响应**：
     ```
     已将传感器温度设置为22摄氏度。
     ```

### 示例四：数据库无数据时的自动测量 📊

**用户输入**：

```bash
请输入您的问题：请帮我查询一下今天的大棚湿度是多少。
```

**系统处理流程**：

1. **问题分析**：`QuestionAnalysisAgent` 识别任务类型为 `database`。
2. **执行代理**：`DatabaseQueryAgent` 解析用户输入，生成 SQL 查询语句。
3. **查询数据库**：
   - **无数据的情况**（当天数据不存在）：
     - 系统未在数据库中找到当天的数据。
     - **自动测量**：
       - 启动 `SensorMonitorAgent`，激活传感器进行实时湿度测量。
       - 将测量结果存储到远程数据库。
     - **返回结果**：
       ```
       数据库中未找到今天的湿度数据。已进行实时测量，当前湿度为62%。
       ```

### 示例五：摄像头位置调整与作物分析 📷

**用户输入**：

```bash
请输入您的问题：请查看一下1号作物的生长情况，有没有出现病虫害？
```

**系统处理流程**：

1. **问题分析**：`QuestionAnalysisAgent` 识别任务类型为 `crop_growth`。
2. **执行代理**：`CropGrowthExecutionAgent` 负责处理该任务。
3. **位置判断与调整**：
   - 获取摄像头当前的位置（例如，位于 2 号作物）。
   - 判断摄像头不在 1 号作物的位置。
   - **移动摄像头**：
     - 通过 `set_control_value()` 控制滑轨，将摄像头移动到 1 号作物的位置。
     - 等待移动完成，确认摄像头已到达目标位置。
4. **图像捕获与分析**：
   - 使用 `capture_image()` 获取 1 号作物的实时图像。
   - 调用 `ParaSeedMultiAgent`，使用 ParaSeed-Multi 多模态大模型对作物进行病虫害分析。
5. **返回结果**：
   - **系统响应**：
     ```
     已查看1号作物。当前生长状况良好，未发现明显的病虫害迹象。叶片健康，颜色正常。建议继续保持定期检查。
     ```

## 常见问题 ❓

### 1. 如何添加新的作物设备信息？ 🌿

您可以在代码中的 `crop_device_info` 字典中添加新的作物信息，例如：

```python
crop_device_info = {
    "1号作物": {"deviceID": "modbus", "weizhi": 20},
    "2号作物": {"deviceID": "modbus2", "weizhi": 25},
    # 添加更多作物
    "3号作物": {"deviceID": "modbus3", "weizhi": 30},
}
```

### 2. 如何更改 MQTT 或数据库配置？ ⚙️

请在相应的代理类初始化时，修改 MQTT 和数据库的配置参数，例如：

```python
mqtt_broker = "你的 MQTT Broker IP"
mqtt_port = 1883
mqtt_username = "你的 MQTT 用户名"
mqtt_password = "你的 MQTT 密码"

db_host = "你的数据库主机"
db_port = 3306
db_user = "你的数据库用户名"
db_password = "你的数据库密码"
db_name = "你的数据库名"
```

### 3. 如何安全地存储敏感信息？ 🔒

建议使用环境变量或配置文件来存储敏感信息，如 API 密钥、用户名和密码。避免将这些信息直接写入代码中。

## 结语 🎉

ParaSeed-Agent 提供了一个集成多种功能的智能代理系统，旨在为农业领域的应用提供便捷、高效的解决方案。通过合理配置和使用，您可以实现对传感器的远程控制、作物生长监测以及数据库管理等多种功能。

如有任何问题或建议，欢迎提出，共同完善和提升 ParaSeed-Agent 的功能。
